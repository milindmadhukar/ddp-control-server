<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Capture and WebSocket Transmission</title>
</head>
<body>
    <button id="startButton">Start Capture</button>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const startButton = document.getElementById('startButton');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let stream;
        let ws;

        startButton.addEventListener('click', async () => {
            // Set up WebSocket connection
            ws = new WebSocket('ws://localhost:8069/screenshare');

            ws.onopen = () => {
                console.log('WebSocket connection established');
                startCapture();
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
                stopCapture();
            };
        });

        async function startCapture() {
            try {
                console.log('Attempting to start screen capture...');
                stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                console.log('Screen capture stream obtained:', stream);
                const track = stream.getVideoTracks()[0];
                console.log('Video track:', track);
                const settings = track.getSettings();
                console.log('Track settings:', settings);
                canvas.width = settings.width;
                canvas.height = settings.height;

                // Start capturing and sending frames
                captureAndSendFrame();
            } catch (err) {
                console.error('Error starting screen capture:', err);
                console.error('Error name:', err.name);
                console.error('Error message:', err.message);
                console.error('Error stack:', err.stack);
            }
        }

        function stopCapture() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        function captureAndSendFrame() {
            if (!stream) {
                console.error('Stream is not available');
                return;
            }

            const track = stream.getVideoTracks()[0];
            if (!track) {
                console.error('No video track found in the stream');
                return;
            }

            const processor = new ImageCapture(track);

            processor.grabFrame()
                .then(imageBitmap => {
                    ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Send the image data via WebSocket
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(imageData, { binary: true })
                    } else {
                        console.warn('WebSocket is not open. ReadyState:', ws.readyState);
                    }

                    // Schedule the next frame capture
                    requestAnimationFrame(captureAndSendFrame);
                })
                .catch(error => {
                    console.error('Error capturing frame:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    
                    // Attempt to restart capture after a short delay
                    setTimeout(captureAndSendFrame, 1000);
                });
        }
    </script>
</body>
</html>
