<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Screen Sharing with Preview</title>
    <style>
        #preview {
            max-width: 320px;
            max-height: 180px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Live Screen Sharing with Preview</h1>
    <button id="startButton">Start Sharing</button>
    <button id="stopButton" disabled>Stop Sharing</button>
    <p id="status"></p>
    <video id="preview" autoplay muted></video>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusElement = document.getElementById('status');
        const previewVideo = document.getElementById('preview');
        let mediaStream;
        let mediaRecorder;
        let websocket;

        startButton.addEventListener('click', startSharing);
        stopButton.addEventListener('click', stopSharing);

        async function startSharing() {
            try {
                mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = mediaStream.getVideoTracks()[0];
                const videoSettings = videoTrack.getSettings();
                
                statusElement.textContent = `Sharing screen: ${videoSettings.width}x${videoSettings.height}`;
                startButton.disabled = true;
                stopButton.disabled = false;

                // Set up video preview
                previewVideo.srcObject = mediaStream;

                websocket = new WebSocket('ws://localhost:8069/screenshare');
                websocket.binaryType = 'arraybuffer';
                
                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    startRecording();
                };
                
                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    stopSharing();
                };
            } catch (error) {
                console.error('Error starting screen share:', error);
                statusElement.textContent = 'Failed to start screen sharing';
            }
        }

        function startRecording() {
            const mimeType = 'video/webm; codecs=vp8';
            mediaRecorder = new MediaRecorder(mediaStream, {
                mimeType: mimeType,
                videoBitsPerSecond: 1000000 // Adjust as needed
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(event.data);
                }
            };

            mediaRecorder.start(100); // Produce data every 100ms
        }

        function stopSharing() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (websocket) {
                websocket.close();
            }
            startButton.disabled = false;
            stopButton.disabled = true;
            statusElement.textContent = 'Screen sharing stopped';
            previewVideo.srcObject = null;
        }
    </script>
</body>
</html>
